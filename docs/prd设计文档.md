我是Astra。

重新输出精简版PRD。

---

# 七鲜超市配送履约可视化工具 - 产品需求文档

**版本：** V1.0
**日期：** 2026-01-16
**目标：** 3天内完成MVP

---

## 1. 产品定位

### 1.1 解决什么问题

**业务痛点：**
- 不知道哪些区域经常超时 → 无法针对性优化
- 门店覆盖范围随意划定 → 范围重叠或空白
- 无法评估运力分配合理性 → 高峰期爆单

**产品价值：**
- 用地图可视化直观展示配送问题
- 用科学方法划分门店服务范围
- 用数据支撑调度决策

### 1.2 核心用户与场景

**用户：** 区域运营经理、配送调度主管
**使用场景：**
- 早会：查看昨日超时热点区域，部署当日改进措施
- 实时：监控高峰期运力分布，决定是否调配骑手
- 周会：分析门店覆盖合理性，优化服务范围

---

## 2. 功能架构

```
├─ 地图可视化（核心）
│  ├─ 门店位置标记
│  ├─ 服务范围可视化（泰森多边形）
│  ├─ 订单热力图
│  ├─ 超时订单预警
│  └─ 配送路径对比
│
├─ 数据面板
│  ├─ 整体数据总览
│  └─ 门店详细指标
│
├─ 控制功能
│  ├─ 图层开关
│  ├─ 门店筛选
│  └─ 数据刷新
│
└─ 洞察建议
   ├─ 异常预警
   └─ 优化建议
```

**优先级：**
- P0（必须）：门店标记、服务范围、订单热力图、超时预警
- P1（重要）：图层控制、数据面板
- P2（可选）：配送路径对比、洞察建议

---

## 3. 核心功能设计

### 3.1 门店位置标记

**功能：** 在地图上展示6家七鲜门店位置及核心数据

**信息展示：**
```
悬停显示：门店名称、日均单量、准时率
点击显示：
- 门店名称
- 地址
- 日均单量：320单
- 准时率：87%
- 平均配送时长：23分钟
- 超时订单数：42单
```

**交互：**
- 侧边栏点击门店 → 地图定位到该门店并缩放
- 点击地图门店图标 → 弹出详情卡片
- 双击门店 → 聚焦并显示该门店的服务范围

**数据结构：**
```python
STORE = {
    id: 1
    name: "七鲜超市(北京姚家园万象汇店)"
    lat: 39.9283
    lon: 116.5089
    daily_orders: 320
    on_time_rate: 0.87
    avg_delivery_time: 23  # 分钟
    timeout_orders: 42
}
```

---

### 3.2 服务范围划分

**功能：** 用泰森多边形科学划分每个门店的服务范围

**业务逻辑：**
1. 使用泰森多边形算法（最近邻原则）生成不重叠的区域
2. 用15分钟骑行等时圈作为边界约束
3. 取两者交集作为最终服务范围
4. 简化多边形为6-12个顶点

**原理：** 任何一个订单坐标，都分配给离它最近的门店

**为什么用泰森多边形？**
- 科学：基于距离最优原则
- 无重叠：避免门店抢单
- 无空白：确保全覆盖

**呈现：**
- 不同门店用不同颜色半透明填充
- 点击某区域高亮显示并展示统计信息
- 统计信息：覆盖面积5.2km²、日均单量320单

**数据结构：**
```python
SERVICE_AREA = {
    store_id: 1
    polygon: [
        {lat: 39.93, lon: 116.51},
        {lat: 39.94, lon: 116.52},
        # ... 6-12个点
    ]
    area_sqkm: 5.2
    daily_orders: 320
}
```

---

### 3.3 订单热力图

**功能：** 展示订单在地理空间的分布密度

**业务价值：**
- 识别订单热点区域（需要重点保障运力）
- 对比不同门店的订单分布特征
- 发现潜在的服务空白区

**生成规则：**
- 订单分布符合距离衰减（离门店越近订单越多）
- 默认展示"青年西路店"（单量最大）
- 颜色：蓝色（低密度）→ 黄色（中密度）→ 红色（高密度）

**交互：**
- 侧边栏选择门店 → 切换到该门店的订单热力图
- 叠加服务范围图层 → 查看订单是否均匀覆盖
- 悬停高密度区域 → 显示"该区域订单密度：23单/km²"

**数据结构：**
```python
ORDER = {
    order_id: "202601160001"
    store_id: 1
    customer_lat: 39.9320
    customer_lon: 116.5150
    order_time: "2026-01-16 18:05:23"
    delivery_time: "2026-01-16 18:28:15"
    duration: 23  # 分钟
    is_timeout: false
}
```

---

### 3.4 超时订单预警

**功能：** 在地图上标记超时订单的位置，识别"配送黑洞"

**业务价值：**
- 识别高频超时区域（如某小区门禁严格）
- 分析超时原因（距离远 vs 末端配送难）
- 支持针对性改进措施

**超时定义：** 实际配送时长 > 30分钟（承诺时间）

**呈现方式：**
- 红色圆点标记超时订单
- 点击显示：配送时长45分钟、超时15分钟、超时原因
- 如果某区域超时订单聚集（500米内>5单）→ 用红色区域高亮标记

**超时原因分类：**
```
- 距离过远（35%）：服务范围边界订单
- 小区门禁（25%）：封闭式小区限制骑手进入
- 电梯等待（15%）：高层住宅电梯慢
- 地库难找（10%）：大型社区地下车库复杂
- 其他（15%）：用户不在家、交通拥堵等
```

**业务洞察逻辑：**
```
IF 某区域500米内超时订单 > 5单 AND 超时率 > 30% THEN
    标记为"配送黑洞"
    分析主要超时原因
    生成改进建议
```

**改进建议示例：**
```
发现：姚家园店东北的"XX花园"超时率32%
原因：小区门禁严格（占70%）
建议：
1. 与物业协商为骑手办理通行证
2. 引导用户到小区门口自提
3. 评估是否调整服务范围边界
```

**数据结构：**
```python
TIMEOUT_ORDER = {
    order_id: "202601160001"
    lat: 39.9320
    lon: 116.5150
    duration: 45  # 分钟
    timeout_duration: 15  # 分钟
    reason: "小区门禁限制"
    reason_category: "门禁类"
}
```

---

### 3.5 配送路径对比

**功能：** 对比骑手实际路径与优化路径，发现效率提升空间

**业务价值：**
- 识别低效路线（如回头路）
- 量化优化空间（可节省X分钟）
- 培训新手骑手

**场景：** 一趟配送包含3-4个订单的多点配送

**展示内容：**
- 蓝色虚线：骑手实际路径（总时长28分钟）
- 绿色实线：推荐优化路径（总时长23分钟）
- 标注：优化后可节省5分钟

**优化逻辑（简化版TSP问题）：**
```
问题：给定N个配送点，如何排序使总距离最短？

贪心算法：
1. 从门店出发
2. 每次选择距离当前点最近的未送达点
3. 送完所有点后返回门店

举例：
实际路径：门店 → B(3km) → A(2km) → C(1.5km) → 门店
优化路径：门店 → A(2km) → C(1.5km) → B(3km) → 门店
```

**为什么有价值？**
- 如果全门店应用优化路径 → 日均节省50小时
- 相当于增加2名骑手产能，无需增加人力成本

**交互：**
- 侧边栏展示最近的配送行程列表
- 选择某趟行程 → 地图展示双路径对比
- 点击配送点 → 显示送达时间、停留时长

**数据结构：**
```python
DELIVERY_TRIP = {
    trip_id: "T20260116001"
    rider_id: "R001"
    store_id: 1
    orders: [
        {seq: 1, lat: 39.9283, lon: 116.5089},  # 门店
        {seq: 2, lat: 39.9320, lon: 116.5150},  # 订单1
        {seq: 3, lat: 39.9280, lon: 116.5180},  # 订单2
    ]
    actual_path: [...GPS轨迹点...]
    actual_duration: 28
    optimal_path: [...推荐路径点...]
    optimal_duration: 23
    time_saved: 5
}
```

---

## 4. 界面布局

### 4.1 整体结构

```
┌────────────────────────────────────────────┐
│          浏览器窗口（100%宽高）              │
│  ┌─────────────────────┬─────────────────┐ │
│  │                     │                 │ │
│  │                     │   侧边栏        │ │
│  │     地图区域         │   (380px)      │ │
│  │   (自适应宽度)       │                 │ │
│  │                     │  ┌───────────┐  │ │
│  │                     │  │ 数据总览  │  │ │
│  │                     │  ├───────────┤  │ │
│  │                     │  │ 图层控制  │  │ │
│  │                     │  ├───────────┤  │ │
│  │                     │  │ 门店列表  │  │ │
│  │                     │  │ (可滚动)  │  │ │
│  │                     │  ├───────────┤  │ │
│  │                     │  │ 洞察建议  │  │ │
│  │                     │  └───────────┘  │ │
│  └─────────────────────┴─────────────────┘ │
└────────────────────────────────────────────┘
```

### 4.2 侧边栏模块

**数据总览卡片（4个指标卡片）：**
```
[🏪 6] 覆盖门店
[📦 2,200] 日均单量
[✓ 89%] 准时率（绿色）
[⚠ 3] 预警区域（橙色）
```

**图层控制（6个开关）：**
```
☑ 门店位置
☑ 服务覆盖范围
☑ 订单热力图
☑ 超时订单预警
☐ 配送路径分析
```

**门店列表（6个门店卡片）：**
```
姚家园店                [📍][✏️][🗑️]
日均单量：320  准时率：87%

青年西路店              [📍][✏️][🗑️]
日均单量：450  准时率：92%
...
```

**洞察建议面板：**
```
⚠️ 超时预警
姚家园店东北区域超时率32%
建议：增派1名骑手 + 联系物业

✓ 表现优异
青年西路店准时率92%
可推广经验：提前增加兼职骑手

💡 优化建议
好世界店与东土城店范围重叠30%
建议：动态调整边界
```

---

## 5. 交互逻辑

### 5.1 核心操作流程

**流程1：定位到某个门店**
```
用户点击侧边栏的"姚家园店" 
  → 地图平滑移动到该门店坐标
  → 缩放到合适级别(zoom=14)
  → 门店图标弹跳3次（强调）
  → 自动弹出门店详情卡片
  → 侧边栏数据面板更新为该门店数据
```

**流程2：诊断超时问题**
```
用户点击地图上的红色超时订单点
  → 弹出卡片：配送时长45分钟、超时原因
  → 用户点击"查看诊断报告"
  → 侧边栏洞察面板展开
  → 显示该区域的详细分析和改进建议
```

**流程3：对比配送路径**
```
用户在侧边栏选择"路径对比分析"
  → 展示最近的配送行程列表
  → 用户点击某趟行程
  → 地图清空其他图层，只显示该门店
  → 绘制蓝色实际路径和绿色优化路径
  → 标注"可节省5分钟"
```

### 5.2 图层联动规则

```
关闭"服务覆盖范围" → 自动关闭"订单热力图"（因为热力图需要叠加在服务范围上看）
打开"配送路径分析" → 自动关闭其他非相关图层（避免视觉混乱）
选择某个门店 → 高亮该门店的所有相关图层（服务范围、订单、超时点）
```

### 5.3 状态管理

```
应用状态：
- current_store: 当前选中的门店ID（默认null显示全部）
- visible_layers: 当前显示的图层列表
- selected_trip: 当前选中的配送行程（用于路径对比）

状态变化：
选中门店 → current_store更新 → 触发地图定位 + 数据面板更新
切换图层 → visible_layers更新 → 触发地图重绘
```

---

## 6. 数据与业务规则

### 6.1 门店基础数据

```python
STORES = [
    {
        "id": 1,
        "name": "七鲜超市(北京姚家园万象汇店)",
        "lat": 39.941334,
        "lon": 116.515733,
        "daily_orders": 320,
        "on_time_rate": 0.87
    },
    {
        "id": 2,
        "name": "七鲜超市(青年西路店)",
        "lat": 39.975499,
        "lon": 116.498254,
        "daily_orders": 450,
        "on_time_rate": 0.92
    },
    {
        "id": 3,
        "name": "七鲜超市(北京好世界店)",
        "lat": 39.920878,
        "lon": 116.463258,
        "daily_orders": 380,
        "on_time_rate": 0.89
    },
    {
        "id": 4,
        "name": "京东七鲜(东土城路店)",
        "lat": 39.847554,
        "lon": 116.320283,
        "daily_orders": 290,
        "on_time_rate": 0.85
    },
    {
        "id": 5,
        "name": "七鲜超市(酒仙桥中路店)",
        "lat": 39.975499,
        "lon": 116.498254,
        "daily_orders": 410,
        "on_time_rate": 0.91
    },
    {
        "id": 6,
        "name": "七鲜超市(北京东坝万达店)",
        "lat": 39.962149,
        "lon": 116.549171,
        "daily_orders": 350,
        "on_time_rate": 0.88
    }
]
```

### 6.2 业务计算规则

**准时率计算：**
```
准时率 = 准时订单数 / 总订单数
准时定义：实际送达时间 ≤ 承诺时间（30分钟）

评级：
≥95% → 优秀（绿色）
90-94% → 良好（浅绿）
85-89% → 合格（黄色）
80-84% → 待改进（橙色）
<80% → 较差（红色）
```

**超时风险评估：**
```
风险评分 = 距离系数×0.4 + 历史超时率×0.6

距离系数：
< 2km: 0分
2-3km: 30分
> 3km: 60分

风险等级：
< 30分 → 低风险（绿色）
30-60分 → 中风险（黄色）
> 60分 → 高风险（红色）
```

**配送黑洞识别：**
```
IF 某区域500米内超时订单 > 5单 
   AND 该区域超时率 > 30%
THEN 标记为配送黑洞（红色区域高亮）
```

---

## 7. 洞察生成逻辑

**业务规则：**
```
异常预警（触发条件）：
- 某门店超时率 > 20%
- 某区域超时订单聚集（500米内>5单）

优化建议（触发条件）：
- 两个门店服务范围重叠 > 30%
- 配送路径优化空间 > 10%

表现优异（触发条件）：
- 准时率 > 92%
- 订单量增长 > 20% 且准时率不降
```

**洞察优先级：**
```
高优先级：影响 > 100单/天
中优先级：影响 50-100单/天
低优先级：影响 < 50单/天

展示：在洞察面板显示Top 3条洞察
```

---

## 8. 技术约束

**地图底图：** 高德地图浅色瓦片（国内访问快）

**数据处理：**
- 服务范围：泰森多边形算法（scipy.spatial.Voronoi）
- 订单分布：距离衰减模型生成模拟数据
- 路径优化：贪心算法（TSP问题简化版）

**性能要求：**
- 页面加载 < 3秒
- 地图交互响应 < 100ms
- 支持500+订单点的热力图渲染

**交付物：**
使用VUE3框架构建SPA应用
---

## 附录：设计说明要点

1. **业务理解**
   - 七鲜即时零售的核心挑战：30分钟配送承诺
   - 本工具的定位：从"看数据"到"诊断业务"

2. **功能亮点**
   - 泰森多边形科学划分服务范围（体现物流工程思维）
   - 超时订单地理聚类识别配送黑洞（直接解决痛点）
   - 配送路径对比量化优化空间（支持决策）

3. **技术方案**
   - 高德地图浅色底图（国内访问快）
   - 数据尽可能在build时内嵌（无外部依赖）
   - 符合真实业务的数据生成逻辑